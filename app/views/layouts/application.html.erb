<!DOCTYPE html>
<html>
<head>
  <title>Task Manager</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>

  <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
  <%= javascript_importmap_tags %>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">

    <%= link_to "Task Manager", tasks_path, class: "navbar-brand" %>

    <div class="collapse navbar-collapse justify-content-between">

      <% if user_signed_in? %>

      <div class="d-flex align-items-center me-auto">

        <ul class="navbar-nav me-3">

          <li class="nav-item">
            <%= link_to "GÃ¶revlerim", tasks_path, class: "nav-link" %>
          </li>

          <li class="nav-item">
            <%= link_to "Yeni GÃ¶rev", new_task_path, class: "nav-link" %>
          </li>

        </ul>

        <!-- Live Search -->

        <form class="d-flex me-2"
          action="<%= tasks_path %>"
          method="get">


          <input class="form-control me-2"
            type="search"
            id="task-search"
            placeholder="BaÅŸlÄ±ÄŸa gÃ¶re ara...">

        </form>

        <%= link_to "ðŸ—‘ï¸ Ã‡Ã¶p Kutusu",
          trash_path,
          class: "btn btn-outline-warning btn-sm" %>

      </div>

      <ul class="navbar-nav">

        <li class="nav-item me-3 text-white mt-2">
          <%= current_user.email %>
        </li>

        <li class="nav-item">
          <%= button_to "Ã‡Ä±kÄ±ÅŸ",
            destroy_user_session_path,
            method: :delete,
            class: "btn btn-outline-light btn-sm" %>
        </li>

      </ul>

      <% end %>

    </div>
  </div>
</nav>

<!-- FLASH -->

<div class="container mt-3">

  <% flash.each do |type, message| %>

    <% css =
      case type.to_sym
      when :notice then "alert-success"
      when :warning then "alert-warning"
      when :alert then "alert-danger"
      else "alert-info"
      end %>

    <div class="alert <%= css %> alert-dismissible fade show mx-2">

      <%= message %>

      <button type="button"
        class="btn-close"
        data-bs-dismiss="alert"></button>

    </div>

  <% end %>

</div>

<div class="container mt-4 mb-5">
  <div class="card shadow-sm p-4 bg-white">
    <%= yield %>
  </div>
</div>

<!-- MODAL -->

<div class="modal fade" id="confirmModal" tabindex="-1">

  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 id="confirmTitle"></h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body" id="confirmBody"></div>

      <div class="modal-footer">

        <button class="btn btn-secondary" data-bs-dismiss="modal">
          Ä°ptal
        </button>

        <button class="btn btn-danger" id="confirmOk">
          Onayla
        </button>

      </div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("turbo:load", function () {

  //CONFIRM MODAL
  

  let currentForm = null;
  const confirmBtn = document.getElementById("confirmOk");

  window.showConfirm = function(title, body, form) {

    document.getElementById("confirmTitle").innerText = title;
    document.getElementById("confirmBody").innerText = body;

    currentForm = form;

    const modal = new bootstrap.Modal(
      document.getElementById("confirmModal")
    );

    modal.show();
  };

  if (confirmBtn) {
    confirmBtn.addEventListener("click", function () {
      if (currentForm) {
        currentForm.requestSubmit();
        currentForm = null;
      }
    });
  }

  
     //LIVE SEARCH
  

   const input = document.getElementById("task-search");
  if (!input) return;

  let timer = null;
  let controller = null; // eski request iptal iÃ§in

  input.addEventListener("input", function () {

    clearTimeout(timer);

    timer = setTimeout(() => {

      // Ã–nceki isteÄŸi iptal et
      if (controller) {
        controller.abort();
      }

      controller = new AbortController();

      const query = input.value;
      const url = new URL(window.location.href);

      if (query.length > 0) {
        url.searchParams.set("search", query);
      } else {
        url.searchParams.delete("search");
      }

      fetch(url, { signal: controller.signal })
        .then(res => res.text())
        .then(html => {

          const doc = new DOMParser()
            .parseFromString(html, "text/html");

          const newList = doc.querySelector("#tasks-list");
          const oldList = document.querySelector("#tasks-list");

          if (newList && oldList) {
            oldList.innerHTML = newList.innerHTML;
          }

        })
        .catch(err => {
          if (err.name !== "AbortError") {
            console.error(err);
          }
        });

    }, 350);

  });

});
</script>




</body>
</html>
